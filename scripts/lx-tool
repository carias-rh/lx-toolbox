#!/bin/bash
# LX Tool - Shell wrapper for lx_toolbox CLI
# Automatically uses the virtualenv Python without requiring activation

set -e

# Resolve the actual script location (follow symlinks)
SOURCE="${BASH_SOURCE[0]}"
while [[ -L "$SOURCE" ]]; do
    DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
    SOURCE="$(readlink "$SOURCE")"
    # If SOURCE is relative, resolve it relative to the symlink's directory
    [[ "$SOURCE" != /* ]] && SOURCE="$DIR/$SOURCE"
done
SCRIPT_DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
LX_TOOLBOX_DIR="$(dirname "$SCRIPT_DIR")"

# Find the virtualenv Python interpreter (check both .venv and venv)
if [[ -x "${LX_TOOLBOX_DIR}/.venv/bin/python3" ]]; then
    VENV_PYTHON="${LX_TOOLBOX_DIR}/.venv/bin/python3"
elif [[ -x "${LX_TOOLBOX_DIR}/venv/bin/python3" ]]; then
    VENV_PYTHON="${LX_TOOLBOX_DIR}/venv/bin/python3"
else
    echo "Error: Virtual environment not found at ${LX_TOOLBOX_DIR}/.venv or ${LX_TOOLBOX_DIR}/venv" >&2
    echo "Please run the setup playbook first: ansible-playbook playbooks/setup.yml -K" >&2
    exit 1
fi

# Add lx_toolbox to Python path and run as module
export PYTHONPATH="${LX_TOOLBOX_DIR}:${PYTHONPATH}"
exec "$VENV_PYTHON" -m lx_toolbox.main "$@"
