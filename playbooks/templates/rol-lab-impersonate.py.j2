#!/usr/local/bin/python3
### Maintained by carias@redhat.com

import time, os.path
from selenium import webdriver
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.common.by import By

## Firefox webdriver
driver = webdriver.Firefox()

driver.install_addon(os.path.expanduser('{{ playbook_dir }}/../copy_on_select-1.0-an+fx.xpi'), temporary=True)
driver.maximize_window()


# Go to the website
def go_to_main_site(lab_environment):
    driver.get('https://rol.redhat.com/' + lab_environment + '/app')


def go_to_course(lab_environment, course_id):
    WebDriverWait(driver, 100).until(EC.element_to_be_clickable(
        (By.XPATH, '//*[@id="avatar"]')))
    driver.get('https://rol.redhat.com/' + lab_environment + '/app/courses/' + course_id)


def login():

    try:
        driver.find_element("xpath", "/html/body/div[1]/main/div/div/div[1]/div[2]/div[2]/div/section[1]/form/div[1]/input").send_keys("{{ rh_username }}@redhat.com")
        WebDriverWait(driver, 10).until(EC.element_to_be_clickable(
            (By.XPATH, '//*[@id="login-show-step2"]'))).click()

        WebDriverWait(driver, 10).until(EC.element_to_be_clickable(
            (By.XPATH, '//*[@id="rh-sso-flow"]'))).click()

        # RH SSO
        WebDriverWait(driver, 10).until(EC.element_to_be_clickable(
            (By.XPATH, '//*[@id="submit"]')))
        driver.find_element("xpath", '//*[@id="username"]').send_keys("{{ username }}")
        counter = os.popen("cat {{ playbook_dir }}/../counter").read()
        token = os.popen("oathtool --hotp {{ secret }} -c " + str(counter)).read().replace('\n', '')
        driver.find_element("xpath", '//*[@id="password"]').send_keys(
            str("{{ pin }}").replace('\n', '') + str(token).replace('\n', ''))
        driver.find_element("xpath", '//*[@id="submit"]').click()

        # Increment SSO token counter
        counter = int(counter) + 1
        os.popen("echo " + str(counter) + " > {{ playbook_dir }}/../counter")

    except:
        print("An exception occurred while accepting during login")



def accept_cookies():
    try:
        WebDriverWait(driver, 10).until(
            EC.frame_to_be_available_and_switch_to_it((By.XPATH, '//iframe[@title="TrustArc Cookie Consent Manager"]')))
        time.sleep(1)
        WebDriverWait(driver, 10).until(EC.element_to_be_clickable((By.XPATH, "//a[@class='call'][text()='Agree and proceed with standard settings']"))).click()
        driver.refresh()
    except:
        print("An exception occurred while accepting cookies")


def impersonate():
    try:
        driver.refresh()
        WebDriverWait(driver, 180).until(EC.element_to_be_clickable(
            (By.XPATH, '//*[text()="Switch user"]'))).click()

        WebDriverWait(driver, 10).until(EC.element_to_be_clickable(
            (By.XPATH, '/html/body/div[3]/div[2]/div/div/div[2]/form/button')))
        driver.find_element("xpath",'//*[@id="formInlineUsername"]').send_keys("{{ impersonate_username }}")

 
        driver.find_element("xpath", "/html/body/div[3]/div[2]/div/div/div[2]/form/button").click()
        time.sleep(2)

    except:
        print("An exception occurred while impersonating {{ impersonate_username }}")

## Main

go_to_main_site("{{ lab_environment }}")
accept_cookies()
login()

{% for course in course_id -%}
accept_cookies()
impersonate()
go_to_course("{{ lab_environment }}", "{{ course }}")

{% endfor -%}
