- name: LX Toolbox installer
  hosts: localhost
  become: true
  vars:
    lx_toolbox_dir: "{{ playbook_dir | dirname }}"
    wrapper_scripts:
      - start
      - stop
      - delete
      - recreate
      - impersonate
      - qa
      - snow-ai
      - check-links

  tasks:
    - name: Ensure system dependencies are installed
      ansible.builtin.package:
        name:
          - python3-pip
          - python3-virtualenv
          - firefox
          - chromium
          - chromedriver
        state: present
      tags: install

    - name: Install Python dependencies in virtualenv
      ansible.builtin.pip:
        requirements: "{{ lx_toolbox_dir }}/requirements.txt"
        virtualenv: "{{ lx_toolbox_dir }}/venv"
        virtualenv_command: python3 -m venv
      tags: install

    - name: Download geckodriver
      ansible.builtin.get_url:
        url: "https://github.com/mozilla/geckodriver/releases/download/v0.36.0/geckodriver-v0.36.0-linux64.tar.gz"
        dest: "/tmp/geckodriver-v0.36.0-linux64.tar.gz"
      tags: drivers

    - name: Extract geckodriver into /usr/bin/
      ansible.builtin.unarchive:
        src: "/tmp/geckodriver-v0.36.0-linux64.tar.gz"
        dest: "/usr/bin/"
      tags: drivers


    # LX Toolbox symlinks (use repo directly, no /opt copy)
    - name: Create symlink for lx-tool in /usr/bin/
      ansible.builtin.file:
        src: "{{ lx_toolbox_dir }}/scripts/lx-tool"
        dest: "/usr/bin/lx-tool"
        state: link
        force: yes
      tags: scripts

    - name: Create symlinks for wrapper scripts in /usr/bin/
      ansible.builtin.file:
        src: "{{ lx_toolbox_dir }}/playbooks/templates/wrapper-scripts/{{ item }}"
        dest: "/usr/bin/{{ item }}"
        state: link
        force: yes
      loop: "{{ wrapper_scripts }}"
      tags: scripts

    - name: Set LX_TOOLBOX_DIR in /etc/environment
      ansible.builtin.lineinfile:
        path: /etc/environment
        regexp: '^LX_TOOLBOX_DIR='
        line: 'LX_TOOLBOX_DIR={{ lx_toolbox_dir }}'
        create: yes
      tags: scripts

    - name: Install Ollama (for AI features)
      ansible.builtin.shell: curl -fsSL https://ollama.com/install.sh | sh
      args:
        creates: /usr/bin/ollama
      tags: 
        - install
        - ai-capabilities


    - name: Display post-installation message
      ansible.builtin.debug:
        msg:
          - "LX Toolbox Installation Complete!"
          - ""
          - "Installed from: {{ lx_toolbox_dir }}"
          - ""
          - "Available commands: lx-tool, start, stop, delete, recreate, impersonate, qa, check-links, snow-ai"
          - ""
          - "To update: git pull"
      tags: always


