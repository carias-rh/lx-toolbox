#!/usr/local/bin/python3
### Maintained by carias@redhat.com

import time, sys
from selenium import webdriver
from selenium.webdriver.support.ui import Select
from selenium.webdriver.support import expected_conditions as EC


options = webdriver.ChromeOptions()
options.add_argument('--ignore-certificate-errors')
options.add_argument('headless')
options.add_argument('--no-sandbox')
options.add_argument("--window-size=1920,1080")

# from selenium.webdriver.firefox.options import Options
# Define the webdriver to use.
driver = webdriver.Chrome(executable_path="/usr/bin/chromedriver", chrome_options=options)

# Go to the website
def go_to_main_site(lab_environment):
    driver.get('https://rol.redhat.com/' + lab_environment + '/app')
    time.sleep(3)


def go_to_course(lab_environment, course_id):
    driver.get('https://rol.redhat.com/' + lab_environment + '/app/courses/' + course_id)
    time.sleep(6)


def login():

    try:
        userid_login_box = driver.find_element_by_xpath("/html/body/div[1]/main/div/div/div[1]/div[2]/div[2]/div/section[1]/form/div[1]/input")
        userid_login_box.send_keys("{{ rh_username }}@redhat.com")
        
        next_button = driver.find_element_by_xpath('//*[@id="login-show-step2"]')
        next_button.click()
        time.sleep(2)
        
        next_button = driver.find_element_by_xpath('//*[@id="rh-sso-flow"]')
        next_button.click()
        time.sleep(2)
    
        userid_login_box = driver.find_element_by_xpath('//*[@id="username"]')
        userid_login_box.send_keys("carias")

        password_login_box = driver.find_element_by_xpath('//*[@id="password"]')
        password_login_box.send_keys("{{ pin }}{{ token.stdout }}")
    
        login_button = driver.find_element_by_xpath('//*[@id="submit"]')
        login_button.click()
        time.sleep(10)

    except:
        print("An exception occurred while login")
        time.sleep(3)


def accept_cookies():
    try:

        driver.switch_to.frame(driver.find_element_by_class_name('truste_popframe'))
    
        accept_cookies_button = driver.find_element_by_xpath('/html/body/div[8]/div[1]/div/div[3]/a[1]')
        accept_cookies_button.click()
        driver.execute_script("arguments[0].click();", accept_cookies_button)
        time.sleep(3)
    except:
        print("An exception occurred while accepting cookies")


def delete_lab(lab_environment, course_id):
    labs_tab = driver.find_element_by_xpath('//*[@id="course-tabs-tab-8"]/span[2]')
    labs_tab.click()
    time.sleep(3)
    
    try:    
        delete_lab = driver.find_element_by_xpath("//*[text()='Delete']")
        #delete_lab = driver.find_element_by_xpath("/html/body/div[1]/article/div/div[3]/div/section/div[2]/div/div[3]/div/div/div[3]/button[1]")
        delete_lab.click()

        delete_lab_confirm = driver.find_element_by_xpath("/html/body/div[3]/div[2]/div/div/div[2]/button[1]")
        delete_lab_confirm.click()
 
        time.sleep(8)
    except:
        print("An exception occurred during lab deletion in " + lab_environment + " environment and course " + course_id)
 

def create_lab(lab_environment, course_id):
    labs_tab = driver.find_element_by_xpath('//*[@id="course-tabs-tab-8"]/span[2]')
    labs_tab.click()
    time.sleep(3)
    
    try:    
        #create_start_lab = driver.find_element_by_xpath("//*[text()='Create']")
        create_start_lab = driver.find_element_by_xpath('//*[@id="tab-course-lab-environment"]/div/div[3]/button')
        #create_start_lab = driver.find_element_by_xpath("/html/body/div[1]/article/div/div[3]/div/section/div[2]/div/div[3]/div/div/div[3]/button")
        create_start_lab.click()
    
        time.sleep(15)
    except:
        print("An exception occurred during lab creation in " + lab_environment + " environment and course " + course_id)
        
def lab_is_ready(lab_environment, course_id):
    labs_tab = driver.find_element_by_xpath('//*[@id="course-tabs-tab-8"]/span[2]')
    labs_tab.click()
    time.sleep(3)

    try:
        #open_console = driver.find_element_by_xpath("/html/body/div[1]/article/div/div[3]/div/section/div[2]/div/div[3]/div/div/div[4]/table/tbody/tr[13]/td[3]/button")
        #open_console = WebDriverWait(driver, 20).until(EC.element_to_be_clickable((By.XPATH, "/html/body/div[1]/article/div/div[3]/div/section/div[2]/div/div[3]/div/div/div[4]/table/tbody/tr[13]/td[3]/button"))
        #open_console.click()

        time.sleep(15)
    except:
        print("An exception occurred during lab creation in " + lab_environment + " environment and course " + course_id)


## Main

go_to_main_site("{{ lab_environment }}")
login()
accept_cookies()

{% for course in course_id -%}

go_to_course("{{ lab_environment }}", "{{ course }}")
delete_lab("{{ lab_environment }}", "{{ course }}")
create_lab("{{ lab_environment }}", "{{ course }}")
#lab_is_ready("{{ lab_environment }}", "{{ course }}")

{% endfor -%}

driver.quit()
